From e10c1eb9908c2774c16b3148b30d2f3823d66a9a Mon Sep 17 00:00:00 2001
From: Xi Wang <xi.wang@gmail.com>
Date: Thu, 15 Mar 2012 04:46:49 +0800
Subject: [PATCH] Fix calloc() overflow

* malloc.c (calloc): Check multiplication overflow in calloc(),
assuming REDIRECT_MALLOC.
---
 malloc.c |    5 +++++
 1 file changed, 5 insertions(+)

Index: libgc/malloc.c
===================================================================
--- libgc.orig/malloc.c	2008-03-10 06:33:41.000000000 +0100
+++ libgc/malloc.c	2012-07-08 18:08:40.030368600 +0200
@@ -344,8 +344,13 @@
   }
 #endif
 
+#ifndef SIZE_MAX
+#define SIZE_MAX (~(size_t)0)
+#endif
 void * calloc(size_t n, size_t lb)
 {
+    if (lb && n > SIZE_MAX / lb)
+      return NULL;
 #   if defined(GC_LINUX_THREADS) /* && !defined(USE_PROC_FOR_LIBRARIES) */
 	/* libpthread allocated some memory that is only pointed to by	*/
 	/* mmapped thread stacks.  Make sure it's not collectable.	*/
